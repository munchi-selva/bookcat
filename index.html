<!DOCTYPE html>
<html>
    <head>
        <!--meta name="viewport" content="width=device-width, initial-scale=1"-->
        <script src="https://code.jquery.com/jquery-latest.js"></script>
        <script src="https://unpkg.com/@ag-grid-enterprise/all-modules/dist/ag-grid-enterprise.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/ag-grid-enterprise/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="https://unpkg.com/ag-grid-enterprise/dist/styles/ag-theme-balham.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    </head>
    <style>
        .main-div
        {
            height: 550px;
            width:  100%;
        }

        .info
        {
            font-size:  large;
            font-style: italic;
        }

        .panel-heading
        {
            font-size:  medium;
        }

        .panel-collapse
        {
            margin: 0.5em 0em 0em;
        }

        .grid-settings
        {
            padding:    2em 0.5em 0.5em;
        }

        .invalid-data
        {
            background-color:   red;
        }
    </style>
    <body>
        <div id="testDiv"></div>

        <div id="catGrid" class="main-div ag-theme-balham container-fluid">
            <h2>Ex libris ... munchi</h2>
            <div class="panel-group">
                <div id="divCatInfo" class="info"></div>
                <div class="panel-heading">
                    <!-- Click to show/hide catalogue file selection and editing options -->
                    <a data-toggle="collapse" href="#divCatSelectForm">Catalogue file options</a>
                </div>
                <div id="divCatSelectForm" class="panel-collapse collapse">
                    <div class="panel-body">
                        <form id="catDataForm" class="form-inline">
                            <button type="button" id="btnLoadDefault" class="btn btn-primary">Load default catalogue</button>
                            <span style="padding:0em 2em;">
                                <input type="file" id="fileinputCat" class="form-control">
                                <button type="button" id="btnLoad" class="btn btn-primary">Load catalogue</button>
                            </span>
                            <button type="button" id="btnProcessUpdates" class="btn btn-primary">Save updated catalogue</button>
                        </form>
                        <hr/>
                    </div>
                </div>
            </div>
            <div class="grid-settings">
                <!-- Selection of data source -->
                <div class="form-check-inline">
                    <label class="form-check-label">Data source:</label>
                </div>
                <div class="form-check-inline">
                    <label class="form-check-label" for="srcComb">
                        <input type="radio" class="form-check-input" id="srcComb" name="optSrc" value="combined">combined
                    </label>
                </div>
                <div class="form-check-inline">
                    <label class="form-check-label" for="srcMC">
                        <input type="radio" class="form-check-input" id="srcMC" name="optSrc" value="base" checked>munchi
                    </label>
                </div>
                <div class="form-check-inline">
                    <label class="form-check-label" for="srcOL">
                        <input type="radio" class="form-check-input" id="srcOL" name="optSrc" value="openlib">openlib
                    </label>
                </div>
                <div class="form-check-inline">
                    <label class="form-check-label" for="srcAma">
                        <input type="radio" class="form-check-input" id="srcAma" name="optSrc" value="amazon">amazon
                    </label>
                </div>
            </div>
        </div>

        <script type="text/javascript" charset="utf-8">
            // ISBN handling
            const REGEX_ISBN13              = new RegExp(/^978[0-9]{9}[0-9X]$/);
            const REGEX_ISBN10              = new RegExp(/^[0-9]{9}[0-9X]$/);
            const ISBN13_DIGITS             = 13;
            const ISBN13_MOD_FACTOR         = 10;
            const ISBN10_DIGITS             = 10;
            const ISBN10_MAX_DIGIT_WEIGHT   = 10;
            const ISBN10_MOD_FACTOR         = 11;

            // Mapping between currency codes and symbols
            const CURRENCY_PREFIXES =
            {
                "AUD":  "$",
                "EUR":  "€",
                "GBP":  "£",
                "SGD":  "$SGD",
                "USD":  "$US",
                "VND":  "₫"
            };

            // Mass conversions
            const LB_TO_OZ  = 16;
            const OZ_TO_KG  = 0.028;
            const LB_TO_KG  = LB_TO_OZ * OZ_TO_KG;
            const G_TO_KG   = 0.001;

            const BCK_FLAG_BIT_OPENLIB_SYNCED   = 0;
            const BCK_FLAG_BIT_IN_OPENLIB       = 1;
            const BCK_FLAG_BIT_INVALID_ISBN13   = 2;
            const BCK_FLAG_BIT_INVALID_ISBN10   = 3;

            const CAT_FLD_SRC_BASE          = "base";
            const CAT_FLD_SRC_AMAZON        = "amazon";
            const CAT_FLD_SRC_OPENLIB       = "openlib";
            const CAT_FLD_SRC_COMB          = "combined";

            const CAT_FLD_ID                    = "id";
            const CAT_FLD_ISBN13                = "isbn_13";
            const CAT_FLD_ISBN10                = "isbn_10";
            const CAT_FLD_PURCH_DATE            = "purchase_date";
            const CAT_FLD_ARR_DATE              = "arrival_date";
            const CAT_FLD_SELLER                = "seller";
            const CAT_FLD_SELLER_BRANCH         = "seller_branch";
            const CAT_FLD_PURCHASER             = "purchaser";
            const CAT_FLD_PURCH_PRICE           = "purchase_price";
            const CAT_FLD_SHIP_PRICE            = "shipping_price";
            const CAT_FLD_CURRENCY              = "purchase_currency";
            const CAT_FLD_NUM_IN_ORDER          = "number_in_order";
            const CAT_FLD_AUTHORS               = "authors";
            const CAT_FLD_AUTHOR_SURNAME        = "surname";
            const CAT_FLD_AUTHOR_GIVEN_NAMES    = "given_names";
            const CAT_FLD_TITLE                 = "title";
            const CAT_FLD_SUBTITLE              = "subtitle";
            const CAT_FLD_PUBLISHERS            = "publishers";
            const CAT_FLD_FLAGS                 = "flags";
            const CAT_FLD_DIM                   = "dimensions";
            const CAT_FLD_DIM_HEIGHT            = "height";
            const CAT_FLD_DIM_WIDTH             = "width";
            const CAT_FLD_DIM_THICKNESS         = "thickness";
            const CAT_FLD_DIM_LENGTH            = "length";
            const CAT_FLD_DIM_MASS              = "mass";
            const CAT_FLD_DIM_MASS_UNITS        = "mass_units";
            const CAT_FLD_INFO_URL              = "info_url";

            // Faking an enum
            const NameEnum =
            {
                "NAME_SUR":     0,
                "NAME_GIVEN":   1
            };
            Object.freeze(NameEnum);

            // Delimiters in fields that represent lists
            const AUTH_SEP  = ";";
            const TITLE_SEP = ":";
            const PUB_SEP   = ";";

            const REGEX_EXT         = new RegExp(/[.][^.]*$/);  // File extension regular expression
            const UPDATED_CAT_EXT   = ".updated";

            // Default column options
            const defaultBookCol =
            {
                sortable:   true,
                filter:     true,
                resizable:  true,
                editable:   true
            };

            // Column definitions
            let bookColumns =
            [
                {
                    headerName: "ID",
                    field:      CAT_FLD_ID,
                    editable:   false,
                    hide:       true
                },
                {
                    headerName:         "Resynch",
                    checkboxSelection:  true,
                    headerTooltip:      "Check for updated openlib details",
                },
                {
                    headerName: "In openlib",
                    valueGetter: function(params)
                    {
                        return inOpenLib(params.data) ? "✓" : "";
                    },
                    headerTooltip: "Book exists in openlib",
                    editable:       false
                },
                {
                    headerName: "Purchase Details",
                    children:
                    [
                        {
                            headerName: "Purchase Date",
                            field:      CAT_FLD_PURCH_DATE,
                            hide:       false
                        },
                        {
                            headerName: "Arrival Date",
                            valueGetter: function(params)
                            {
                                arrDate = getFld(params.data, [CAT_FLD_ARR_DATE], CAT_FLD_SRC_BASE);
                                if (!arrDate)
                                {
                                    arrDate = getFld(params.data, [CAT_FLD_PURCH_DATE], CAT_FLD_SRC_BASE);
                                }
                                return arrDate;
                            },
                            valueSetter: function(params)
                            {
                                setFld(params.data, [CAT_FLD_ARR_DATE], params.newValue, CAT_FLD_SRC_BASE);
                                return true;
                            },
                            hide    : true
                        },
                        {headerName: "Seller", field: CAT_FLD_SELLER, hide: false},
                        {headerName: "Seller Branch", field: CAT_FLD_SELLER_BRANCH, hide: true},
                        {headerName: "Purchaser", field: CAT_FLD_PURCHASER, hide: true},
                        {headerName: "#", field: CAT_FLD_NUM_IN_ORDER, hide: true},
                        {
                            headerName: "Currency",
                            field: CAT_FLD_CURRENCY,
                            cellEditor: 'agRichSelectCellEditor',
                            cellEditorParams:
                            {
                                values: ["AUD", "EUR", "GBP", "SGD", "USD", "VND", ""]
                            },
                            onCellValueChanged: function(params)
                            {
                                gridOptions.api.redrawRows();
                            },
                            hide: true
                        },
                        {
                            headerName: "Price",
                            field: CAT_FLD_PURCH_PRICE,
                            cellRenderer: function(params)
                            {
                                if (params.value)
                                {
                                    cellString = isCatFldValid(params) ? formatAsCurrency(params) : params.value;
                                    return markFldValidity(params, cellString);
                                }
                            },

                            hide: false
                        },
                        {
                            headerName: "Shipping",
                            field: CAT_FLD_SHIP_PRICE,
                            cellRenderer: function(params)
                            {
                                if (params.value)
                                {
                                    cellString = isCatFldValid(params) ? formatAsCurrency(params) : params.value;
                                    return markFldValidity(params, cellString);
                                }
                            },

                            hide: false
                        },
                        {
                            headerName: "Total Price",
                            valueGetter: function(params)
                            {
                                let price = getFld(params.data, [CAT_FLD_PURCH_PRICE], CAT_FLD_SRC_BASE);
                                let shippingPrice = getFld(params.data, [CAT_FLD_SHIP_PRICE], CAT_FLD_SRC_BASE);

                                if (!isNaN(price))
                                {
                                    price = parseFloat(price);
                                    if (shippingPrice && !isNaN(shippingPrice))
                                    {
                                        price += parseFloat(shippingPrice);
                                    }
                                }

                                return price;
                            },
                            cellRenderer: function(params)
                            {
                                if (params.value)
                                {
                                    if (isCatFldValid(params))
                                    {
                                        currency = getFld(params.data, [CAT_FLD_CURRENCY])
                                        return (formatAsCurrency(params));
                                    }
                                }
                            },
                            editable: false,
                            hide: false
                        }
                    ]
                },
                {
                    headerName: "Book Identifiers",
                    children:
                    [
                        {
                            headerName: "ISBN 13",
                            field:      CAT_FLD_ISBN13,
                            cellRenderer: function(params)
                            {
                                cellString = params.value;
                                return markFldValidity(params, cellString);
                            },
                            hide:   false
                        },
                        {
                            headerName: "ISBN 10",
                            field:      CAT_FLD_ISBN10,
                            cellRenderer: function(params)
                            {
                                cellString = params.value;
                                return markFldValidity(params, cellString);
                            },
                            hide:       true
                        }
                    ]
                },
                {
                    headerName: "Author/Editor",
                    suppressMenu: false,
                    children:
                    [
                        {
                            headerName: "Surname",
                            valueGetter: function(params)
                            {
                                return getAuthorNames(params, NameEnum.NAME_SUR);
                            },
                            valueSetter: function(params)
                            {
                                return setAuthorNames(params, NameEnum.NAME_SUR);
                            }
                        },
                        {
                            headerName: "Given Name(s)",
                            valueGetter: function(params)
                            {
                                return getAuthorNames(params, NameEnum.NAME_GIVEN);
                            },
                            valueSetter: function(params)
                            {
                                return setAuthorNames(params, NameEnum.NAME_GIVEN);
                            }

                        }
                    ]
                },
                {
                    headerName: "Title",
                    valueGetter: function(params)
                    {
                        let title       = getFld(params.data, [CAT_FLD_TITLE]);
                        let subtitle    = getFld(params.data, [CAT_FLD_SUBTITLE]);
                        if (subtitle)
                        {
                            title += TITLE_SEP + " " + subtitle;
                        }
                        return title;
                    },
                    valueSetter: function(params)
                    {
                        // Split the input value into title and subtitle
                        let titleComponents = (params.newValue.split(TITLE_SEP)).map(function(comp) {return String.prototype.trim.apply(comp);});;
                        let title           = titleComponents.shift();
                        let subtitle        = titleComponents.length > 0 ? titleComponents.join(TITLE_SEP + " ") : null;
                        return (setFld(params.data, [CAT_FLD_TITLE], title) &&
                                setFld(params.data, [CAT_FLD_SUBTITLE], subtitle));
                    },
                    cellRenderer: function(params)
                    {
                        cellString = params.value;
                        infoUrl = getFld(params.data, [CAT_FLD_INFO_URL], CAT_FLD_SRC_OPENLIB);
                        if (infoUrl)
                        {
                            cellString = '<a href="' + infoUrl + '" target="_blank">' + cellString + '</a>';
                        }
                        return cellString;
                    },
                },
                {
                    headerName: "Publisher",
                    valueGetter: function(params)
                    {
                        pubSrc      = getFld(params.data, [CAT_FLD_PUBLISHERS]);
                        pubString   = pubSrc ? pubSrc.join(PUB_SEP + " ") : null;
                        return pubString;
                    },
                    valueSetter: function(params)
                    {
                        let pubs = (params.newValue.split(PUB_SEP)).map(function(comp) {return String.prototype.trim.apply(comp);});
                        return(setFld(params.data, [CAT_FLD_PUBLISHERS], pubs));
                    }
                },
                {
                    headerName: "Dimensions",
                    children:
                    [
                        {
                            headerName: "H (cm)",
                            valueGetter: function(params)
                            {
                                return getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_HEIGHT]);
                            },
                            valueSetter: function(params)
                            {
                                return(setFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_HEIGHT], params.newValue));
                            },
                            hide: true
                        },
                        {
                            headerName: "W (cm)",
                            valueGetter: function(params)
                            {
                                return getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_WIDTH]);
                            },
                            valueSetter: function(params)
                            {
                                return(setFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_WIDTH], params.newValue));
                            },
                            hide: true
                        },
                        {
                            headerName: "T (cm)",
                            valueGetter: function(params)
                            {
                                return getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_THICKNESS]);
                            },
                            valueSetter: function(params)
                            {
                                return(setFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_THICKNESS], params.newValue));
                            },
                            hide: true
                        },
                        {
                            headerName: "Length (pp)",
                            valueGetter: function(params)
                            {
                                return getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_LENGTH]);
                            },
                            valueSetter: function(params)
                            {
                                return(setFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_LENGTH], params.newValue));
                            },
                            hide: true
                        },
                        {
                            headerName: "Mass (kg)",
                            valueGetter: function(params)
                            {
                                mass    = null;
                                rawMass = getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_MASS]);
                                if (rawMass)
                                {
                                    mass = parseFloat(rawMass);
                                    units = getFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_MASS_UNITS]);
                                    if (units)
                                    {
                                        switch (units)
                                        {
                                            case "ounces":
                                            {
                                                mass *= OZ_TO_KG;
                                                break;
                                            }
                                            case "pounds":
                                            {
                                                mass *= LB_TO_KG;
                                                break;
                                            }
                                            default:
                                            {
                                                mass *= G_TO_KG;
                                                break;
                                            }
                                        }
                                    }
                                }
                                return mass;
                            },
                            valueSetter: function(params)
                            {
                                return(setFld(params.data, [CAT_FLD_DIM, CAT_FLD_DIM_MASS], params.newValue));
                            },
                            cellRenderer: function(params)
                            {
                                if (params.value)
                                {
                                    cellString = formatAsMass(params.value);
                                    if (!isCatFldValid(params))
                                    {
                                    }
                                    return (formatAsMass(params.value));
                                }
                            },
                            hide: true
                        }
                    ]
                }
            ];

            // Default grid configuration (empty data)
            let gridOptions =
            {
                defaultColDef:          defaultBookCol,
                columnDefs:             bookColumns,
                rowSelection:           'multiple',
                enableRangeSelection:   true,           // Allow multiple values in the same column to be selected/copied
                suppressRowTransform:   true,           // Allow row spanning
                rowData:                [],
                onRowSelected: function(params)
                {
                    if (getFld(params.data, [CAT_FLD_FLAGS], CAT_FLD_SRC_BASE))
                    {
                        // Toggle selected item's openlib (re)synch flag
                        params.data.flags ^= (1 << BCK_FLAG_BIT_OPENLIB_SYNCED);
                    }
                }
            };

            let catFilename = '';
            let catData     = [];

            $(document).ready(function()
            {
                // Initialise the catalogue grid
                let gridDiv = document.querySelector('#catGrid');
                new agGrid.Grid(gridDiv, gridOptions);
                loadDefaultCat();

                // Load/display selected catalogue data
                $("#btnLoad").click(function()
                {
                    loadSelectedCat();
                });

                $("#fileinputCat").change(function()
                {
                    // Load catalogue data in response to file selection
                    loadSelectedCat();
                });

                $("#btnLoadDefault").click(function()
                {
                    // Load catalogue data in response to button click
                    loadDefaultCat();
                });

                // Save a version of the catalogue file with selected items flagged
                // for resynch with openlib
                $("#btnProcessUpdates").click(function()
                {
                    let catDataString = JSON.stringify(catData, null, 4);
                    let updatedCatFile = new Blob([catDataString], {type: "text/plain;charset=UTF-8"});
                    let updatedCatFileElem = document.createElement("a");
                    updatedCatFileElem.href = URL.createObjectURL(updatedCatFile);

                    // Generate updated catalogue filename
                    let catFilenameExt  = REGEX_EXT.exec(catFilename);
                    let updatedCatFilename = catFilename.replace(catFilenameExt, UPDATED_CAT_EXT + catFilenameExt);
                    updatedCatFileElem.download = updatedCatFilename;

                    updatedCatFileElem.click();
                });

                $("#chkUseOpenlib").click(function()
                {
                    gridOptions.api.redrawRows();
                });

                $("[name='optSrc']").click(function()
                {
                    //console.log($("[name='optSrc']:checked").val());
                    gridOptions.api.redrawRows();
                });
            });

            function loadDefaultCat()
            {
                catFilename = "Books.cat";

                let xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function()
                {
                    if (this.readyState == 4 && this.status == 200)
                    {
                        catData = JSON.parse(this.responseText);
                        populateGrid(catData);
                    }
                };
                xmlhttp.open("GET", catFilename, true);
                xmlhttp.send();
            }

            function loadSelectedCat()
            {
                let fileinput, fileReader;

                // Parse file input element
                fileinput = document.getElementById("fileinputCat");
                if (!fileinput)
                {
                    alert("Couldn't find the catalogue file HTML element.");
                }
                else if (!fileinput.files)
                {
                    alert("This browser doesn't seem to support the `files` property of file inputs.");
                }
                else if (!fileinput.files[0])
                {
                    alert("Please select a catalogue file before clicking 'Load'");
                }
                else
                {
                    catFilename = fileinput.files[0].name;
                    catFile = fileinput.files[0];
                    fileReader = new FileReader();
                    fileReader.onload = receivedText;
                    fileReader.readAsText(catFile);
                }

                // Proceess catalogue file contents
                function receivedText(e)
                {
                    catData = JSON.parse(e.target.result);
                    populateGrid(catData);
                }
            }

            // Populate the catalogue grid
            function populateGrid(catData)
            {
                gridOptions.api.setRowData(catData);
                gridOptions.columnApi.autoSizeColumns();
                gridOptions.api.sizeColumnsToFit();

                document.getElementById("divCatInfo").innerHTML = "Displaying catalogue: '" + catFilename + "'";
            }

            // Format a field as a currency string
            function formatAsCurrency(fldParams)
            {
                priceString = Number.parseFloat(fldParams.value).toFixed(2);
                currency = getFld(fldParams.data, [CAT_FLD_CURRENCY], CAT_FLD_SRC_BASE);
                if (currency)
                {
                    if (currency == 'VND')
                    {
                        priceString += CURRENCY_PREFIXES[currency];
                    }
                    else
                    {
                        priceString = CURRENCY_PREFIXES[currency] + priceString;
                    }
                }

                return (priceString);
            }

            function formatAsMass(mass)
            {
                return (Number.parseFloat(mass).toFixed(3));
            }

            // Checks if a catalogue record includes a field, which is
            // represented by a chain of keys,
            //  e.g. hasFld(catRec, ["openlib", "dimensions", "thickness"])
            //       returns true if catRec["openlib"]["dimensions"]["thickness"] exists
            function hasFld(catRec, keyChain)
            {
                for (catRecLevel = 0; catRecLevel < keyChain.length; catRecLevel++)
                {
                    key = keyChain[catRecLevel]
                    if (!catRec || !(key in catRec))
                    {
                        return false;
                    }
                    catRec = catRec[key];
                }
                return true;
            }

            // Fetches a field from a catalogue record
            function getFld(catRec, keyChain, dataSrc = getDataSrc())
            {
                let dataSrcList = dataSrc == CAT_FLD_SRC_COMB ? [CAT_FLD_SRC_BASE, CAT_FLD_SRC_OPENLIB, CAT_FLD_SRC_AMAZON] : [dataSrc];
                let fld = null;
                while(dataSrcList.length > 0 && !fld)
                {
                    let fldSrc = dataSrcList.shift();
                    let fldKeyChain = (fldSrc == CAT_FLD_SRC_BASE) ? keyChain : [fldSrc].concat(keyChain);
                    if (hasFld(catRec, fldKeyChain))
                    {
                        // Recursive fetching of object properties...
                        let obj = catRec;
                        while (fldKeyChain.length > 0)
                        {
                            obj = obj[fldKeyChain.shift()];
                        }
                        fld = obj;
                    }
                }

                return fld;
            }

            // Sets a field value
            function setFld(catRec, keyChain, value, dataSrc = getDataSrc())
            {
                if (dataSrc == CAT_FLD_SRC_COMB)
                {
                    return false;
                }

                let fldKeyChain = (dataSrc == CAT_FLD_SRC_BASE) ? keyChain : [dataSrc].concat(keyChain);
                let obj = catRec;
                let key = null;
                while (fldKeyChain.length > 1)
                {
                    key = fldKeyChain.shift();
                    if (key in obj)
                    {
                        obj = obj[key];
                    }
                    else
                    {
                        // Initialise...
                        obj[key] = {};
                        obj = obj[key];
                    }
                }
                obj[fldKeyChain.shift()] = value;

                return true;
            }

            // Return true if a given catalogue record has an openlib entry
            function inOpenLib(catRec)
            {
                return (hasFld(catRec, [CAT_FLD_FLAGS]) &&
                        getFld(catRec, [CAT_FLD_FLAGS], CAT_FLD_SRC_BASE) & (1 << BCK_FLAG_BIT_IN_OPENLIB));
            }

            function hasOpenlibFld(params, key)
            {
                return (hasFld(params.data, [CAT_FLD_SRC_OPENLIB, key]));
            }

            function useOpenlibData()
            {
                return chkUseOpenlib.checked;
            }

            function getDataSrc()
            {
                return ($("[name='optSrc']:checked").val());
            }

            function getAuthorNames(params, nameType)
            {
                authData = getFld(params.data, [CAT_FLD_AUTHORS]);
                namesString = "";

                if (authData)
                {
                    for (authIdx = 0; authIdx < authData.length; authIdx++)
                    {
                        if (namesString)
                        {
                            namesString += AUTH_SEP + " ";
                        }
                        if (nameType == NameEnum.NAME_SUR)
                        {
                            if (CAT_FLD_AUTHOR_SURNAME in authData[authIdx])
                            {
                                namesString += authData[authIdx][CAT_FLD_AUTHOR_SURNAME];
                            }
                        }
                        else if (nameType == NameEnum.NAME_GIVEN)
                        {
                            if (CAT_FLD_AUTHOR_GIVEN_NAMES in authData[authIdx])
                            {
                                namesString += authData[authIdx][CAT_FLD_AUTHOR_GIVEN_NAMES].join(" ");
                            }
                        }
                    }
                }
                return namesString;
            }

            function setAuthorNames(params, nameType)
            {
                authData = JSON.parse(JSON.stringify(getFld(params.data, [CAT_FLD_AUTHORS])));
                if (!authData)
                {
                    authData = {};
                }

                newNames = params.newValue ? (params.newValue.split(AUTH_SEP)).map(function(comp) {return String.prototype.trim.apply(comp);}) : [];
                console.log(newNames);

                for (authIdx = newNames.length; authIdx < authData.length; authIdx++)
                {
                    if (nameType == NameEnum.NAME_SUR)
                    {
                        delete(authData[authIdx][CAT_FLD_AUTHOR_SURNAME]);
                    }
                    else
                    {
                        delete(authData[authIdx][CAT_FLD_AUTHOR_GIVEN_NAMES]);
                    }
                }

                for (nameIdx = 0; nameIdx < newNames.length && nameIdx < authData.length; nameIdx++)
                {
                    if (nameType == NameEnum.NAME_SUR)
                    {
                        authData[nameIdx][CAT_FLD_AUTHOR_SURNAME] = newNames[nameIdx];
                    }
                    else
                    {
                        authData[nameIdx][CAT_FLD_AUTHOR_GIVEN_NAMES] = newNames[nameIdx].split();
                    }
                }

                for (; nameIdx < newNames.length; nameIdx++)
                {
                    newAuth = {};
                    if (nameType == NameEnum.NAME_SUR)
                    {
                        newAuth[CAT_FLD_AUTHOR_SURNAME] = newNames[nameIdx];
                        newAuth[CAT_FLD_AUTHOR_GIVEN_NAMES] = [];
                    }
                    else
                    {
                        newAuth[CAT_FLD_AUTHOR_SURNAME] = "";
                        newAuth[CAT_FLD_AUTHOR_GIVEN_NAMES] = newNames[nameIdx].split();
                    }
                    authData.push(newAuth);
                }

                /*
                for (authIdx = newNames.length; authIdx < authData.length; authIdx++)
                {
                    if (Object.keys(authData[authIdx]).length == 0)
                    {
                    }
                }
                */
                return setFld(params.data, [CAT_FLD_AUTHORS], authData);
            }

            // Computes the expected check digit for a candidate ISBN
            function calcISBNCheckDigit(isbnCandidate)
            {
                let checkDigit = -1;
                if (REGEX_ISBN10.test(isbnCandidate))
                {
                    checkDigit = 0;
                    for (let idx = 0; idx < ISBN10_DIGITS - 1; idx++)
                    {
                        checkDigit += (ISBN10_MAX_DIGIT_WEIGHT - idx) * parseInt(isbnCandidate[idx]);
                    }
                    checkDigit %= ISBN10_MOD_FACTOR;
                    if (checkDigit > 0)
                    {
                        checkDigit = ISBN10_MOD_FACTOR - checkDigit;
                    }
                    return checkDigit < 10 ? checkDigit.toString() : 'X';
                }
                else if (REGEX_ISBN13.test(isbnCandidate))
                {
                    checkDigit = 0
                    for (let idx = 0; idx < ISBN13_DIGITS - 1; idx++)
                    {
                        if (idx % 2 == 0)
                        {
                            checkDigit += parseInt(isbnCandidate[idx]);
                        }
                        else
                        {
                            checkDigit += 3 * parseInt(isbnCandidate[idx]);
                        }
                    }
                    checkDigit = ISBN13_MOD_FACTOR - checkDigit % ISBN13_MOD_FACTOR;
                    return checkDigit < 10 ? checkDigit.toString() : '0';
                }
                return checkDigit.toString();
            }

            // Checks if a given catalogue record field's contents are valid:
            // validation steps depend on the field's expected data type, etc.
            function isCatFldValid(fldParams)
            {
                let valid = true;
                let fldId = fldParams.column.colId;
                switch (fldId)
                {
                    case CAT_FLD_ISBN13:
                    case CAT_FLD_ISBN10:
                        let isbnCandidate = fldParams.value;
                        if (isbnCandidate)
                        {
                            let isbnRegexMatch = fldId == CAT_FLD_ISBN13 ? REGEX_ISBN13.test(isbnCandidate) : REGEX_ISBN10.test(isbnCandidate);
                            valid = isbnRegexMatch && (calcISBNCheckDigit(isbnCandidate) == isbnCandidate[isbnCandidate.length - 1]);
                        }
                        break;

                    case CAT_FLD_PURCH_PRICE:
                    case CAT_FLD_SHIP_PRICE:
                        let priceCandidate = fldParams.value;
                        if (priceCandidate)
                        {
                            valid = !isNaN(priceCandidate);
                        }

                    default:
                }

                return valid;
            }

            function markFldValidity(fldParams, cellString)
            {
                return isCatFldValid(fldParams) ? cellString : '<span class="invalid-data">' + cellString + '</span>';
            }

            // Test catalogue data
            let testCat =
            [
                {
                    "purchase_date": "2019-09-30",
                    "isbn_13": "9781408886809",
                    "item_within_order": "1",
                    "alt_authors": [
                        {
                            "surname": "Gaiman",
                            "given_names": [
                                "Neil"
                            ]
                        }
                    ],
                    "alt_title": "Norse Mythology",
                    "alt_publishers": [
                        {
                            "name": "Bloomsbury"
                        }
                    ],
                    "seller_id": "LL",
                    "purchase_price": "4.00",
                    "purchase_currency": "AUD"
                },
                {
                    "purchase_date": "2019-09-30",
                    "isbn_13": "9780312427245",
                    "item_within_order": "2",
                    "alt_authors": [
                        {
                            "surname": "Vargos Llosa",
                            "given_names": [
                                "Mario"
                            ]
                        },
                        {
                            "surname": "Lane",
                            "given_names": [
                                "Helen",
                                "R."
                            ]
                        }
                    ],
                    "alt_title": "Aunt Julia and the Scriptwriter",
                    "alt_publishers": [
                        {
                            "name": "Picador"
                        }
                    ],
                    "seller_id": "LL",
                    "purchase_price": "4.00",
                    "purchase_currency": "AUD",
                    "ignored_fields": [
                        "authors"
                    ],
                    "isbn_10": [
                        "0312427247"
                    ],
                    "publishers": [
                        {
                            "name": "Picador"
                        }
                    ],
                    "publish_date": "October 2, 2007",
                    "number_of_pages": 384,
                    "title": "Aunt Julia and the Scriptwriter"
                },
                {
                    "purchase_date": "2019-09-30",
                    "isbn_13": "9781780746357",
                    "item_within_order": "3",
                    "alt_authors": [
                        {
                            "surname": "James",
                            "given_names": [
                                "Marlon"
                            ]
                        }
                    ],
                    "alt_title": "A Brief History of Seven Killings",
                    "alt_publishers": [
                        {
                            "name": "Oneworld"
                        }
                    ],
                    "seller_id": "LL",
                    "purchase_price": "3.00",
                    "purchase_currency": "AUD"
                },
                {
                    "purchase_date": "2019-11-29",
                    "isbn_13": "9788891244390",
                    "alt_authors": [
                        {
                            "surname": "Manara",
                            "given_names": [
                                "Milo"
                            ]
                        }
                    ],
                    "alt_title": "Aunt Julia and the Scriptwriter",
                    "seller_id": "AmazonAU",
                    "purchase_price": "36.15",
                    "shipping_price": "0.00",
                    "purchase_currency": "AUD"
                },
                {
                    "arrival_date": "2019-12-01",
                    "isbn_13": "9783462043235",
                    "item_within_order": "1",
                    "alt_authors": [
                        {
                            "surname": "Kutscher",
                            "given_names": [
                                "Volker"
                            ]
                        }
                    ],
                    "alt_title": "Goldstein",
                    "alt_publishers": [
                        {
                            "name": "Kiepenhauer & Witsch"
                        }
                    ],
                    "notes": "Gift",
                    "authors": [
                        {
                            "given_names": [
                                "Volker"
                            ],
                            "surname": "Kutscher"
                        }
                    ],
                    "isbn_10": [
                        "3462043234"
                    ],
                    "publishers": [
                        {
                            "name": "Kiepenheuer & Witsch GmbH"
                        }
                    ],
                    "publish_date": "1822",
                    "title": "Goldstein"
                },
                {
                    "arrival_date": "2019-12-01",
                    "isbn_13": "9783462046465",
                    "item_within_order": "2",
                    "alt_authors": [
                        {
                            "surname": "Kutscher",
                            "given_names": [
                                "Volker"
                            ]
                        }
                    ],
                    "alt_title": "Die Akte Vaterland",
                    "alt_publishers": [
                        {
                            "name": "Kiepenhauer & Witsch"
                        }
                    ],
                    "notes": "Gift"
                },
                {
                    "purchase_date": "2019-12-06",
                    "isbn_13": "9781786070609",
                    "alt_authors": [
                        {
                            "surname": "Sadawi",
                            "given_names": [
                                "Ahmed"
                            ]
                        }
                    ],
                    "alt_title": "Frankenstein in Baghdad",
                    "alt_publishers": [
                        {
                            "name": "Oneworld"
                        }
                    ],
                    "seller_id": "KinokuniyaSyd",
                    "purchase_price": "9.95",
                    "purchase_currency": "AUD",
                    "publishers": [
                        {
                            "name": "Oneworld Publications"
                        }
                    ],
                    "publish_date": "2018",
                    "title": "Frankenstein in Baghdad"
                },
                {
                    "purchase_date": "2019-12-09",
                    "isbn_13": "9780008132576",
                    "alt_authors": [
                        {
                            "surname": "Stephenson",
                            "given_names": [
                                "Neal"
                            ]
                        },
                        {
                            "surname": "Galland",
                            "given_names": [
                                "Nicole"
                            ]
                        }
                    ],
                    "alt_title": "The Rise and Fall of D.O.D.O",
                    "alt_publishers": [
                        {
                            "name": "Harper Collins"
                        }
                    ],
                    "seller_id": "DymocksGeorgeSt",
                    "purchase_price": "10.00",
                    "purchase_currency": "AUD"
                },
                {
                    "purchase_date": "2019-12-10",
                    "isbn_13": "9780730324218",
                    "alt_authors": [
                        {
                            "surname": "Pape",
                            "given_names": [
                                "Scott"
                            ]
                        }
                    ],
                    "alt_title": "The Barefoot Investor",
                    "alt_publishers": [
                        {
                            "name": "Wiley"
                        }
                    ],
                    "seller_id": "DymocksGeorgeSt",
                    "notes": "Gift",
                    "authors": [
                        {
                            "given_names": [
                                "Scott"
                            ],
                            "surname": "Pape"
                        }
                    ],
                    "isbn_10": [
                        "0730324214"
                    ],
                    "publish_date": "2017",
                    "number_of_pages": 264,
                    "title": "The barefoot investor"
                },
                {
                    "purchase_date": "2019-12-16",
                    "isbn_13": "9780692181065",
                    "alt_authors": [
                        {
                            "surname": "McAuliffe",
                            "given_names": [
                                "Callan"
                            ]
                        }
                    ],
                    "alt_title": "The Hill Ghost",
                    "seller_id": "HH_BJ",
                    "purchase_price": "19.95",
                    "purchase_currency": "AUD"
                }
            ];

            //document.getElementById('testDiv').innerHTML = CURRENCY_PREFIXES['AUD'];
        </script>
    </body>
</html>
